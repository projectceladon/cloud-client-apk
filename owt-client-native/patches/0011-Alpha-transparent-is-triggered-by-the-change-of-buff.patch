From 1a0fb949c07edb1fb65806bf63057bc50ba3e1b9 Mon Sep 17 00:00:00 2001
From: shipeigx <peigangx.shi@intel.com>
Date: Fri, 25 Feb 2022 14:44:03 +0800
Subject: [PATCH] Alpha transparent is triggered by the change of buff.patch

Signed-off-by: shipeigx <peigangx.shi@intel.com>
---
 scripts/prepare_dev.py                        |  1 +
 ...t-is-triggered-by-the-change-of-buff.patch | 46 +++++++++++++++++++
 2 files changed, 47 insertions(+)
 create mode 100644 talk/owt/patches/0024-Alpha-transparent-is-triggered-by-the-change-of-buff.patch

diff --git a/scripts/prepare_dev.py b/scripts/prepare_dev.py
index 0e12013..ce02b78 100644
--- a/scripts/prepare_dev.py
+++ b/scripts/prepare_dev.py
@@ -51,6 +51,7 @@ patchList = [
     ('0021-Fix-display-is-incomplete.patch', WEBRTC_PATH),
     ('0022-Implemented-the-new-transparent-composition-feature.patch', WEBRTC_PATH),
     ('0023-Add-atrace-point-that-is-after-decoding.patch', WEBRTC_PATH),
+    ('0024-Alpha-transparent-is-triggered-by-the-change-of-buff.patch', WEBRTC_PATH),
 ]
 
 def _patch(ignoreFailures=False):
diff --git a/talk/owt/patches/0024-Alpha-transparent-is-triggered-by-the-change-of-buff.patch b/talk/owt/patches/0024-Alpha-transparent-is-triggered-by-the-change-of-buff.patch
new file mode 100644
index 0000000..a106155
--- /dev/null
+++ b/talk/owt/patches/0024-Alpha-transparent-is-triggered-by-the-change-of-buff.patch
@@ -0,0 +1,46 @@
+From 335093a7648669f262216f1262bbaf5ac510644b Mon Sep 17 00:00:00 2001
+From: shipeigx <peigangx.shi@intel.com>
+Date: Wed, 23 Feb 2022 17:45:28 +0800
+Subject: [PATCH] Alpha transparent is triggered by the change of buffersize.
+
+Signed-off-by: shipeigx <peigangx.shi@intel.com>
+---
+ sdk/android/src/java/org/webrtc/GlGenericDrawer.java | 12 +++++++++++-
+ 1 file changed, 11 insertions(+), 1 deletion(-)
+
+diff --git a/sdk/android/src/java/org/webrtc/GlGenericDrawer.java b/sdk/android/src/java/org/webrtc/GlGenericDrawer.java
+index 87c2ebfd0b..119602f1e2 100644
+--- a/sdk/android/src/java/org/webrtc/GlGenericDrawer.java
++++ b/sdk/android/src/java/org/webrtc/GlGenericDrawer.java
+@@ -18,7 +18,7 @@ import org.webrtc.GlShader;
+ import org.webrtc.GlUtil;
+ import org.webrtc.RendererCommon;
+ import org.webrtc.GlDrawerBg;
+-
++import android.util.Log;
+ /**
+  * Helper class to implement an instance of RendererCommon.GlDrawer that can accept multiple input
+  * sources (OES, RGB, or YUV) using a generic fragment shader as input. The generic fragment shader
+@@ -174,9 +174,19 @@ class GlGenericDrawer implements RendererCommon.GlDrawer {
+    * Draw an OES texture frame with specified texture transformation matrix. Required resources are
+    * allocated at the first call to this function.
+    */
++  private int initFrameWidth = 0;
+   @Override
+   public void drawOes(int oesTextureId, float[] texMatrix, int frameWidth, int frameHeight,
+       int viewportX, int viewportY, int viewportWidth, int viewportHeight) {
++    if (initFrameWidth == 0) {
++      initFrameWidth = frameWidth;
++    } else if (frameWidth != initFrameWidth) {
++      //alpha-mode
++      GlUtil.setAlphaChannel(true);
++    } else {
++      //non-alpha-mode
++      GlUtil.setAlphaChannel(false);
++    }
+     prepareShader(
+         ShaderType.OES, texMatrix, frameWidth, frameHeight, viewportWidth, viewportHeight);
+     // Bind base map texture.
+-- 
+2.25.1
+
-- 
2.25.1

